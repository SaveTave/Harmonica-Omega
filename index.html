<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HARMONICA OMEGA v42</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='5' y='25' width='90' height='50' rx='8' fill='%23d4af37' stroke='black' stroke-width='4'/><line x1='5' y1='50' x2='95' y2='50' stroke='black' stroke-width='2'/><circle cx='15' cy='40' r='4' fill='black'/><circle cx='25' cy='40' r='4' fill='black'/><circle cx='35' cy='40' r='4' fill='black'/><circle cx='45' cy='40' r='4' fill='black'/><circle cx='55' cy='40' r='4' fill='black'/><circle cx='65' cy='40' r='4' fill='black'/><circle cx='75' cy='40' r='4' fill='black'/><circle cx='85' cy='40' r='4' fill='black'/></svg>">
    
    <style>
        /* --- THEME: GUITAR OMEGA STATION (UNIFIED) --- */
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --header-bg: #181818;
            
            --primary: #d4af37; /* Gold */
            --secondary: #e0e0e0; /* Silver */
            
            --blow-color: #263238; 
            --draw-color: #3e2723; 
            
            --over-color: #9c27b0; 
            --bend-color: #f57c00; 
            
            --text: #e0e0e0;
            --border: #333;
            
            --lick-highlight: #00e676;
            --pattern-text: #ffe082;
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px;
            background-image: radial-gradient(#222 1px, transparent 1px); background-size: 20px 20px;
        }

        /* --- UI COMPONENTS --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        h1 { margin: 0; color: var(--primary); font-size: 24px; text-transform: uppercase; letter-spacing: 2px; font-weight: 900; }
        
        .lang-btn { 
            background: #222; color: #666; border: 1px solid #444; 
            padding: 5px 15px; cursor: pointer; font-weight: bold; border-radius: 3px; 
            text-transform: uppercase; font-size: 11px; transition: 0.2s;
        }
        .lang-btn.active { 
            background: var(--primary) !important; 
            color: #000 !important; 
            border-color: var(--primary) !important; 
            box-shadow: 0 0 10px rgba(212,175,55,0.5); 
        }

        h3 { 
            margin: 0 0 15px 0; font-size: 11px; font-weight: 700; 
            color: var(--primary); text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 1px solid #333; padding-bottom: 8px;
        }

        .panel { 
            background: var(--panel); border: 1px solid var(--border); 
            border-radius: 4px; padding: 15px; margin-bottom: 20px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 300px; display: flex; flex-direction: column; }
        .col .panel { flex: 1; display: flex; flex-direction: column; margin-bottom: 0; }

        /* CONTROLS */
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; align-items: end; }
        .c-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 10px; color: #888; text-transform: uppercase; font-weight: bold; }
        select, input { 
            background: #0a0a0a; color: #fff; border: 1px solid var(--border); 
            padding: 8px; font-weight: 600; border-radius: 2px; height: 35px; width: 100%;
        }
        select:focus { border-color: var(--primary); outline: none; }
        option.chiussi-opt { color: var(--primary); background: #1a1a1a; font-weight: bold; }
        
        .btn-gold { 
            background: linear-gradient(180deg, #d4af37, #8a7020); color: #000; 
            border: none; padding: 0 15px; height: 35px; font-weight: bold; 
            font-size: 11px; cursor: pointer; border-radius: 2px; text-transform: uppercase;
            width: 100%;
        }
        .btn-gold:hover { filter: brightness(1.2); }

        /* VISUALIZER */
        .harp-wrapper { 
            background: #151515; border: 2px solid #333; border-radius: 6px; 
            padding: 20px 10px; overflow-x: auto; margin-bottom: 20px; 
            box-shadow: inset 0 0 30px #000; position: relative;
        }
        .harp-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; max-width: 900px; margin: 0 auto; }
        .cell { height: 45px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 2px; border: 1px solid #2a2a2a; color: #555; position: relative; transition:0.1s; }
        .tab-txt { font-size: 14px; font-weight: 800; color: inherit; line-height: 1; }
        .note-txt { font-size: 9px; color: #666; margin-top: 1px; }
        .row-num { background: transparent; border: none; color: #fff; height: 25px; margin-bottom: 2px; }
        .row-num .tab-txt { font-size: 14px; color: var(--primary); } .row-num .note-txt { display: none; }
        
        .row-top-aux { background: #0e0e0e; height: 30px; border-bottom: none; align-self: end; border-top: 1px dashed #333; }
        .row-blow { background: var(--blow-color); border-bottom: 2px solid #000; } 
        .row-draw { background: var(--draw-color); border-top: 2px solid #000; margin-top: 2px; }
        .row-bottom-aux { background: #0e0e0e; height: 30px; border-top: none; }
        
        .label-row { position: absolute; left: 5px; font-size: 9px; font-weight: bold; }
        
        .cell.active { background: var(--primary) !important; color: #000 !important; border-color: #fff; box-shadow: 0 0 10px var(--primary); transform: scale(1.05); z-index: 10; }
        .cell.active .tab-txt { color: #000; } .cell.active .note-txt { color: #000; font-weight: 800; }
        .cell.type-over.active { background: var(--over-color) !important; color: #fff !important; } .cell.type-over.active .tab-txt {color:#fff;}
        .cell.type-bend.active { background: var(--bend-color) !important; color: #000 !important; }
        .cell.root { background: #fff !important; color: #000 !important; border: 2px solid var(--primary); z-index: 20; }
        .cell.ghost { opacity: 0.15; filter: grayscale(1); }
        .cell.playing-lick { background: var(--lick-highlight) !important; color: #000 !important; transform: scale(1.15); z-index: 100; box-shadow: 0 0 20px var(--lick-highlight); border-color: #fff; }

        /* THEORY GRIDS */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 5px; margin-bottom: 10px; }
        .info-card { background: #222; border: 1px solid #333; border-radius: 3px; padding: 6px; text-align: center; display: flex; flex-direction: column; gap: 2px; }
        .info-card.root { border-color: var(--primary); background: rgba(212, 175, 55, 0.15); }
        .ic-top { font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; }
        .ic-main { font-size: 13px; font-weight: 900; color: #fff; }
        .ic-sub { font-size: 10px; background: #000; color: var(--primary); padding: 2px; border-radius: 2px; font-family: monospace; }
        .ic-chord { font-size: 9px; color: #ccc; }

        /* UTILITIES */
        .jam-box { background: #151515; border: 1px solid #333; border-left: 3px solid #cc0000; padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 100%; box-sizing: border-box; }
        .jam-text { font-size: 11px; color: #888; }
        .jam-text strong { display: block; font-size: 14px; color: #fff; margin-top: 2px; }
        .btn-yt { background: #cc0000; color: white; border: none; padding: 8px 15px; font-weight: bold; font-size: 11px; border-radius: 2px; cursor: pointer; text-transform: uppercase; }
        .btn-yt:hover { background: #ff0000; }

        .metro-box { background: #151515; border: 1px solid #333; padding: 15px; display: flex; gap: 10px; align-items: center; border-radius: 4px; height: 100%; box-sizing: border-box; }
        .metro-led { width: 10px; height: 10px; background: #222; border-radius: 50%; border: 1px solid #444; }
        .metro-led.on { background: #ff0000; box-shadow: 0 0 8px red; border-color: red; }
        
        .metro-box input, .metro-box select, .metro-box button { height: 30px !important; padding: 0 5px; font-size: 12px; box-sizing: border-box; vertical-align: middle; }
        .btn-play-square { width: 40px; background: var(--primary); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 2px; color: #000; }
        .btn-play-square:hover { filter: brightness(1.2); }

        /* --- GENERATORS --- */
        .gen-display { 
            background: #000; border: 1px solid #333; color: var(--pattern-text); 
            font-family: 'Courier New', monospace; padding: 15px; font-size: 13px; 
            white-space: pre-wrap; overflow-y: auto; border-radius: 2px; 
            margin-bottom: 10px; width: 100%; box-sizing: border-box;
        }
        
        .pat-display-box { flex: 1; display: flex; flex-direction: column; }
        .fill-space { flex-grow: 1; display: flex; flex-direction: column; }
        .fill-space .gen-display { flex-grow: 1; min-height: 80px; }

        .pat-row { display: flex; gap: 10px; margin-top: auto; }
        .pat-btn-group { display: flex; gap: 1px; flex: 1; }
        .pat-btn { 
            background: #222; color: #aaa; border: 1px solid #444; padding: 10px; flex: 1; 
            font-size: 11px; cursor: pointer; border-radius: 0; text-transform: uppercase;
        }
        .pat-btn:first-child { border-radius: 3px 0 0 3px; }
        .pat-btn:last-child { border-radius: 0 3px 3px 0; }
        .pat-btn:hover { background: #333; color: #fff; }

        .lick-display-box { 
            background: #000; border: 1px solid #333; padding: 20px; border-radius: 4px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; min-height: 40px;
            flex-grow: 1;
        }
        .lick-text { font-family: 'Courier New', monospace; font-size: 16px; color: #fff; font-weight: bold; }
        
        .lick-row-selects { display: flex; gap: 10px; margin-bottom: 10px; }
        .lick-row-btns { display: flex; gap: 10px; margin-top: auto; }
        .lick-btn { flex: 1; background: #222; border: 1px solid #444; color: #ccc; padding: 10px; text-transform: uppercase; font-size: 11px; font-weight: bold; cursor: pointer; border-radius: 2px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .lick-btn:hover { border-color: #fff; color: #fff; background: #2a2a2a; }

        @media (max-width: 800px) { .row { flex-direction: column; } .controls-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

    <div class="top-bar">
        <h1>HARMONICA OMEGA</h1>
        <div>
            <button class="lang-btn active" id="btnIT" onclick="setLang('it')">IT</button>
            <button class="lang-btn" id="btnES" onclick="setLang('es')">ES</button>
        </div>
    </div>

    <div class="panel">
        <div class="controls-grid">
            <div class="c-group"><label id="lbl-harp">Chiave</label><select id="harpKey" onchange="render(); saveState();"></select></div>
            <div class="c-group"><label id="lbl-pos">Posizione</label><select id="position" onchange="render(); saveState();"></select></div>
            <div class="c-group" style="flex:2;"><label id="lbl-scale">Scala / Modo</label><select id="scaleSelect" onchange="render(); saveState();"></select></div>
            <div class="c-group"><label id="lbl-cat">Filtro</label><select id="scaleCat" onchange="updateScaleList(); saveState();">
                <option value="all">â˜… TUTTO</option>
                <option value="didattica" class="chiussi-opt">ðŸŽ“ Didattica (Chiussi)</option>
                <option value="std">Standard</option>
                <option value="modi">Modi</option>
                <option value="jazz">Jazz</option>
                <option value="exotic">Etniche</option>
                <option value="arp">Arpeggi</option>
            </select></div>
            <div class="c-group"><button class="btn-gold" id="btn-playscale" onclick="playScaleSimple()">ðŸ”Š PLAY SCALA</button></div>
        </div>
        <div style="text-align:center; margin-top:10px; color:#666; font-size:11px;">
            <span id="lbl-res">TonalitÃ :</span> <strong id="resultKey" style="color:var(--primary); font-size:16px; margin-left:5px;">C</strong>
        </div>
    </div>

    <div class="harp-wrapper">
        <div class="label-row" style="top:30px; color:#444;">TOP</div>
        <div class="label-row" style="top:65px; color:var(--blow-color);">BLOW</div>
        <div class="label-row" style="top:135px; color:var(--draw-color);">DRAW</div>
        <div class="label-row" style="top:175px; color:#444;">BTM</div>

        <div class="harp-grid" id="rowTopAux"></div>
        <div class="harp-grid" id="rowBlow"></div>
        <div class="harp-grid" id="rowNum" style="margin:3px auto;"></div>
        <div class="harp-grid" id="rowDraw"></div>
        <div class="harp-grid" id="rowBottomAux1"></div>
        <div class="harp-grid" id="rowBottomAux2"></div>
        <div class="harp-grid" id="rowBottomAux3"></div>
    </div>

    <div class="panel">
        <h3 id="lbl-map">MAPPA INTERVALLI</h3>
        <div id="intervalGrid" class="info-grid"></div>
        <h3 id="lbl-harm" style="margin-top:20px;">ARMONIZZAZIONE</h3>
        <div id="harmDisplay" class="info-grid"></div>
    </div>

    <div class="row" style="margin-bottom:20px;">
        <div class="col">
            <div class="panel" style="height:100%; box-sizing:border-box; margin:0; padding:0; background:transparent; border:none; box-shadow:none;">
                <h3 style="margin-bottom:10px; border:none;">JAM STATION</h3>
                <div class="jam-box">
                    <div class="jam-text">Backing Track: <strong id="jamTitle">Blues in G</strong></div>
                    <button class="btn-yt" id="btn-yt" onclick="openYouTubeSearch()">â–¶ YOUTUBE</button>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="panel" style="height:100%; box-sizing:border-box; margin:0; padding:0; background:transparent; border:none; box-shadow:none;">
                <h3 id="lbl-rhy" style="margin-bottom:10px; border:none;">METRONOMO</h3>
                <div class="metro-box">
                    <input type="number" id="bpm" value="100" style="width:50px; text-align:center;" onchange="saveState()">
                    <select id="rhythmSel" style="flex:1;" onchange="saveState()"><option value="1">1/4</option><option value="2">1/8</option><option value="3">3</option><option value="swing">Sw</option></select>
                    <button class="btn-play-square" id="btn-metro" onclick="toggleMetronome()">â–¶</button>
                    <div id="metro-led" class="metro-led"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="panel generator-content">
                <h3 id="lbl-pat-title">GENERATORE PATRONES (CHIUSSI)</h3>
                <div class="fill-space">
                    <div id="patternDisplay" class="gen-display">Seleziona un ritmo...</div>
                </div>
                <div class="pat-row">
                    <div class="pat-btn-group">
                        <button class="pat-btn" id="btn-pat-2" onclick="generatePatterns(2)">2</button>
                        <button class="pat-btn" id="btn-pat-3" onclick="generatePatterns(3)">3</button>
                        <button class="pat-btn" id="btn-pat-4" onclick="generatePatterns(4)">4</button>
                    </div>
                    <button class="btn-play-square" style="height:auto;" onclick="playGeneratedPattern()">â–¶</button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="panel generator-content" style="border-left: 4px solid var(--primary);">
                <h3 id="lbl-lib">LICK LIBRARY & AI</h3>
                <div class="fill-space">
                    <div class="lick-display-box">
                        <div id="lickTabDisplay" class="lick-text">...</div>
                    </div>
                </div>
                <div class="lick-row-selects">
                    <select id="lickSelect" onchange="updateLickDisplay()" style="flex:2;"></select>
                    <select id="lickSpeed" style="flex:1;"><option value="400">Slow</option><option value="250" selected>Med</option><option value="120">Fast</option></select>
                </div>
                <div class="lick-row-btns">
                    <button id="btn-gen-ai" class="lick-btn" onclick="generateProceduralLick()">âš¡ AI GEN</button>
                    <button id="btn-play-lick" class="lick-btn" onclick="playCurrentLick()">â–¶ PLAY</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- STRINGS ---
    const i18n = {
        it: {
            harp:"Chiave", pos:"Posizione", scale:"Scala", cat:"Filtro", res:"TonalitÃ :", notes:"NOTE", harm:"ARMONIZZAZIONE",
            map:"MAPPA INTERVALLI", lbl_rhy:"METRONOMO", start:"â–¶", stop:"â¹",
            pat_title:"GENERATORE PATRONES (CHIUSSI)", lbl_lib:"LIBRERIA FRASEGGIO",
            gen_btn:"âš¡ AI GEN", play_btn:"â–¶ PLAY", playscale:"ðŸ”Š PLAY SCALA",
            pat_2:"CROME", pat_3:"TERZINE", pat_4:"SEMICROME", yt_btn:"â–¶ APRI YOUTUBE"
        },
        es: {
            harp:"Tono", pos:"PosiciÃ³n", scale:"Escala", cat:"Filtro", res:"Tonalidad:", notes:"NOTAS", harm:"ARMONIZACIÃ“N",
            map:"MAPA INTERVALOS", lbl_rhy:"METRÃ“NOMO", start:"â–¶", stop:"â¹",
            pat_title:"GENERADOR PATRONES (CHIUSSI)", lbl_lib:"LIBRERÃA DE FRASES",
            gen_btn:"âš¡ IA GEN", play_btn:"â–¶ TOCAR", playscale:"ðŸ”Š TOCAR ESCALA",
            pat_2:"CORCHEAS", pat_3:"TRESILLO", pat_4:"SEMICOR.", yt_btn:"â–¶ ABRIR YOUTUBE"
        }
    };
    let curLang = 'it';
    const notes = ["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"];
    const INTERVAL_NAMES = {0:"R",1:"b2",2:"2",3:"b3",4:"3",5:"4",6:"b5",7:"5",8:"b6",9:"6",10:"b7",11:"7"};

    // --- RICHTER ---
    const richterLogic = [
        {h:1,b:{t:'1',p:0},d:{t:'(1)',p:2},db:[{t:'(1)*',p:1}],ob:{t:'1*',p:3}},
        {h:2,b:{t:'2',p:4},d:{t:'(2)',p:7},db:[{t:'(2)*',p:6},{t:'(2)**',p:5}],ob:null},
        {h:3,b:{t:'3',p:7},d:{t:'(3)',p:11},db:[{t:'(3)*',p:10},{t:'(3)**',p:9},{t:'(3)***',p:8}],ob:null},
        {h:4,b:{t:'4',p:12},d:{t:'(4)',p:14},db:[{t:'(4)*',p:13}],ob:{t:'4+',p:15}},
        {h:5,b:{t:'5',p:16},d:{t:'(5)',p:17},db:[],ob:{t:'5+',p:18}},
        {h:6,b:{t:'6',p:19},d:{t:'(6)',p:21},db:[{t:'(6)*',p:20}],ob:{t:'6+',p:22}},
        {h:7,b:{t:'7',p:24},d:{t:'(7)',p:23},db:[],od:{t:'(7)+',p:25}},
        {h:8,b:{t:'8',p:28},d:{t:'(8)',p:26},bb:[{t:'8*',p:27}],od:{t:'(8)+',p:29}},
        {h:9,b:{t:'9',p:31},d:{t:'(9)',p:29},bb:[{t:'9*',p:30}],od:{t:'(9)+',p:32}},
        {h:10,b:{t:'10',p:36},d:{t:'(10)',p:33},bb:[{t:'10*',p:35},{t:'10**',p:34}],od:{t:'(10)+',p:37}}
    ];

    // --- DATABASE ---
    const scalesDB = [
        {id:"chiussi_blues_complete",name:"Blues 2nd Pos (Leandro Completa)",cat:"didattica",ints:[0,3,4,5,6,7,10],harm:"R, b3, 3, 4, b5, 5, b7"},
        {id:"did_blues_nobend",name:"Blues Facile (No Bends)",cat:"didattica",ints:[0,4,5,7,10],harm:"2a Pos Base"},
        {id:"did_blues_bend",name:"Blues Intermedio (Bend 3')",cat:"didattica",ints:[0,3,4,5,7,10],harm:"Con 3a Minore"},
        {id:"did_boogie",name:"Scala Boogie (Shuffle)",cat:"didattica",ints:[0,4,7,9,10],harm:"Walking Bass"},
        {id:"did_hybrid",name:"Blues Ibrida (Magg/Min)",cat:"didattica",ints:[0,3,4,5,7,9,10],harm:"Mix & Match"},
        {id:"major",name:"Maggiore (Ionica)",cat:"std",ints:[0,2,4,5,7,9,11],harm:"Maj7"},
        {id:"minor",name:"Minore Naturale",cat:"std",ints:[0,2,3,5,7,8,10],harm:"m7"},
        {id:"blues",name:"Scala Blues (Standard)",cat:"std",ints:[0,3,5,6,7,10],harm:"Blues"},
        {id:"pent_maj",name:"Pentatonica Magg",cat:"std",ints:[0,2,4,7,9],harm:"Country"},
        {id:"pent_min",name:"Pentatonica Min",cat:"std",ints:[0,3,5,7,10],harm:"Rock"},
        {id:"dorian",name:"Dorico (Modo II)",cat:"modi",ints:[0,2,3,5,7,9,10],harm:"m7"},
        {id:"mixolydian",name:"Misolidio (Modo V)",cat:"modi",ints:[0,2,4,5,7,9,10],harm:"7"},
        {id:"phrygian",name:"Frigio (Modo III)",cat:"modi",ints:[0,1,3,5,7,8,10],harm:"m7b9"},
        {id:"lydian",name:"Lidio (Modo IV)",cat:"modi",ints:[0,2,4,6,7,9,11],harm:"Maj7#11"},
        {id:"aeolian",name:"Eolio (Modo VI)",cat:"modi",ints:[0,2,3,5,7,8,10],harm:"m7"},
        {id:"locrian",name:"Locrio (Modo VII)",cat:"modi",ints:[0,1,3,5,6,8,10],harm:"m7b5"},
        {id:"harm_minor",name:"Minore Armonica",cat:"jazz",ints:[0,2,3,5,7,8,11],harm:"mMaj7"},
        {id:"mel_minor",name:"Minore Melodica",cat:"jazz",ints:[0,2,3,5,7,9,11],harm:"mMaj7"},
        {id:"lydian_dom",name:"Lidia Dominante",cat:"jazz",ints:[0,2,4,6,7,9,10], harm:"7#11"},
        {id:"altered",name:"Alterata",cat:"jazz",ints:[0,1,3,4,6,8,10], harm:"7alt"},
        {id:"dim_hw",name:"Diminuita",cat:"jazz",ints:[0,1,3,4,6,7,9,10], harm:"dim7"},
        {id:"romanian",name:"Rumena",cat:"exotic",ints:[0,2,3,6,7,9,10], harm:"Minor Folk"},
        {id:"hungarian",name:"Ungherese Minore",cat:"exotic",ints:[0,2,3,6,7,8,11], harm:"Gypsy Minor"},
        {id:"double_harm",name:"Doppia Armonica",cat:"exotic",ints:[0,1,4,5,7,8,11], harm:"Byzantine"},
        {id:"hirajoshi",name:"Hirajoshi",cat:"exotic",ints:[0,2,3,7,8], harm:"Penta Japan"},
        {id:"arp_maj",name:"Arpeggio Maggiore",cat:"arp",ints:[0,4,7], harm:"1-3-5"},
        {id:"arp_min",name:"Arpeggio Minore",cat:"arp",ints:[0,3,7], harm:"1-b3-5"},
        {id:"arp_dom",name:"Arpeggio Dom7",cat:"arp",ints:[0,4,7,10], harm:"1-3-5-b7"},
        {id:"arp_maj7",name:"Arpeggio Maj7",cat:"arp",ints:[0,4,7,11], harm:"1-3-5-7"},
        {id:"arp_min7",name:"Arpeggio Min7",cat:"arp",ints:[0,3,7,10], harm:"1-b3-5-b7"},
        {id:"arp_blues",name:"Arpeggio Blues",cat:"arp",ints:[0,3,4,7,10], harm:"1-b3-3-5-b7"},
        {id:"arp_dim",name:"Arpeggio Diminuito",cat:"arp",ints:[0,3,6], harm:"1-b3-b5"},
        {id:"arp_dim7",name:"Arpeggio Dim7",cat:"arp",ints:[0,3,6,9], harm:"1-b3-b5-bb7"},
        {id:"arp_aug",name:"Arpeggio Aumentato",cat:"arp",ints:[0,4,8], harm:"1-3-#5"}
    ];

    const licksDB = [
        {cat:"Jason Ricci: Ostinatos",name:"Ostinato 4-5 (Trill)",tabs:["(4)","5","(4)","5","(4)","5","(4)"]},
        {cat:"Jason Ricci: Ostinatos",name:"Penta Speed Arp",tabs:["(2)","(3)*","4","(4)","(5)","6"]},
        {cat:"Jason Ricci Style",name:"Overblow Arpeggio",tabs:["4","4+","5","5+","6","6+"]},
        {cat:"Jason Ricci Style",name:"Chromatic Tension",tabs:["(3)*","4","4+","(4)","5"]},
        {cat:"Jason Ricci Style",name:"Minor 3rd Run",tabs:["(3)***","(3)**","(3)*","4","(4)"]},
        {cat:"Jason Ricci Style",name:"Ricci Blues Turn",tabs:["(2)","3","(3)*","4+","4","(2)"]},
        {cat:"Jason Ricci Style",name:"Speed Lick High",tabs:["6","(6)","(5)","5","4","(4)","(3)*"]},
        {cat:"Jason Ricci Style",name:"Funky Overblow",tabs:["(4)","4+","5","5+","6"]},
        {cat:"Turnarounds",name:"Standard Shuffle",tabs:["(2)","(3)*","3","(3)*","(2)"]},
        {cat:"Turnarounds",name:"V-IV-I Classic",tabs:["(4)","(4)*","4","(3)*","(2)"]},
        {cat:"Turnarounds",name:"Double Stop Fade",tabs:["(2)3","(2)3","(2)3","(1)2"]},
        {cat:"Turnarounds",name:"Chromatic Down",tabs:["(3)*","3","(2)","(2)**","1"]},
        {cat:"Chicago Classics",name:"Hoochie Coochie",tabs:["(2)","(2)","(3)*","(2)","4","(2)"]},
        {cat:"Chicago Classics",name:"Mannish Boy",tabs:["(1)","2","(2)","4","(2)"]},
        {cat:"Chicago Classics",name:"Juke Riff (Start)",tabs:["(2)","3","4","3","(2)"]},
        {cat:"Chicago Classics",name:"Walter Boogie",tabs:["(2)","(3)*","4","(4)*","(4)","5"]},
        {cat:"Riffs I Grado (G)",name:"Simple Root",tabs:["(2)","3","(3)*","(2)"]},
        {cat:"Riffs I Grado (G)",name:"Train Chug",tabs:["(2)","3","(2)","3","(2)","3"]},
        {cat:"Riffs I Grado (G)",name:"Octave Jump",tabs:["(2)","3","4","5","6","(6)"]},
        {cat:"Riffs IV Grado (C)",name:"Blow Slide",tabs:["4","5","6","6+"]},
        {cat:"Riffs IV Grado (C)",name:"IV Chord Arp",tabs:["1","2","3","4","5","6"]},
        {cat:"Riffs IV Grado (C)",name:"Shake IV",tabs:["45","45","45"]},
        {cat:"Riffs V Grado (D)",name:"V Tension",tabs:["(4)","(5)","(6)","(4)"]},
        {cat:"Riffs V Grado (D)",name:"Draw V Run",tabs:["(4)","4","(3)*","(2)"]},
        {cat:"Slow Blues",name:"Deep Bending",tabs:["(2)","(2)**","(1)","1","(1)"]},
        {cat:"Slow Blues",name:"Crying 4",tabs:["(4)","(4)*","(4)","4","(3)*","(2)"]}
    ];

    const BASE_FREQ_C4 = 261.63;
    let currentLickSequence = []; let currentPatternSequence = [];

    // --- INIT & PERSISTENCE ---
    function init() {
        const hk = document.getElementById('harpKey');
        notes.forEach((n,i)=>{let o=document.createElement('option');o.value=i;o.text=n;hk.add(o);});
        const pos = document.getElementById('position');
        for(let i=1;i<=12;i++){let o=document.createElement('option');o.value=i;o.text=i+(i===2?" (Cross)":"");pos.add(o);}
        const lSel = document.getElementById('lickSelect');
        let currentCat=""; let group=null;
        licksDB.forEach((l,i)=>{
            if(l.cat!==currentCat){currentCat=l.cat; group=document.createElement('optgroup'); group.label=currentCat; lSel.add(group);}
            let o=document.createElement('option');o.value=i;o.text=l.name;group.appendChild(o);
        });
        
        loadState(); // Auto-Load logic
        if(document.getElementById('scaleSelect').options.length === 0) updateScaleList(); 
        
        render(); updateLickDisplay();
    }

    function saveState() {
        const state = {
            harp: document.getElementById('harpKey').value,
            pos: document.getElementById('position').value,
            cat: document.getElementById('scaleCat').value,
            scale: document.getElementById('scaleSelect').value,
            bpm: document.getElementById('bpm').value,
            rhy: document.getElementById('rhythmSel').value,
            lang: curLang
        };
        localStorage.setItem('omegaState', JSON.stringify(state));
    }

    function loadState() {
        const saved = localStorage.getItem('omegaState');
        if(saved) {
            const s = JSON.parse(saved);
            if(s.harp) document.getElementById('harpKey').value = s.harp;
            if(s.pos) document.getElementById('position').value = s.pos;
            if(s.cat) document.getElementById('scaleCat').value = s.cat;
            updateScaleList();
            if(s.scale) document.getElementById('scaleSelect').value = s.scale;
            if(s.bpm) document.getElementById('bpm').value = s.bpm;
            if(s.rhy) document.getElementById('rhythmSel').value = s.rhy;
            if(s.lang) setLang(s.lang);
        } else {
            setLang('it');
        }
    }

    function setLang(l) {
        curLang = l; const t = i18n[l];
        document.getElementById('lbl-harp').innerText = t.harp;
        document.getElementById('lbl-pos').innerText = t.pos;
        document.getElementById('lbl-cat').innerText = t.cat;
        document.getElementById('lbl-scale').innerText = t.scale;
        document.getElementById('lbl-res').innerText = t.res;
        document.getElementById('lbl-harm').innerText = t.harm;
        document.getElementById('lbl-map').innerText = t.map;
        document.getElementById('lbl-rhy').innerText = t.lbl_rhy;
        document.getElementById('lbl-pat-title').innerText = t.pat_title;
        document.getElementById('lbl-lib').innerText = t.lbl_lib;
        document.getElementById('btn-pat-2').innerText = t.pat_2;
        document.getElementById('btn-pat-3').innerText = t.pat_3;
        document.getElementById('btn-pat-4').innerText = t.pat_4;
        document.getElementById('btn-play-lick').innerText = t.play_btn;
        document.getElementById('btn-gen-ai').innerText = t.gen_btn;
        document.getElementById('btn-playscale').innerText = t.playscale;
        document.getElementById('btn-yt').innerText = t.yt_btn;
        
        // FIX: Active Lang Class
        document.getElementById('btnIT').className = l==='it'?'lang-btn active':'lang-btn';
        document.getElementById('btnES').className = l==='es'?'lang-btn active':'lang-btn';
        saveState();
    }

    function updateScaleList() {
        const cat = document.getElementById('scaleCat').value;
        const sel = document.getElementById('scaleSelect');
        sel.innerHTML="";
        scalesDB.forEach((s,i)=>{if(cat==='all'||s.cat===cat){let o=document.createElement('option');o.value=i;o.text=s.name;sel.add(o);}});
        if(sel.options.length>0) sel.selectedIndex=0;
    }
    
    function updateLickDisplay() {
        const idx = document.getElementById('lickSelect').value;
        if(idx!==""){currentLickSequence=licksDB[idx].tabs; document.getElementById('lickTabDisplay').innerText=currentLickSequence.join(" - ");}
    }

    // --- AUDIO & GENERATORS ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function resumeAudio() { if(audioCtx.state==='suspended') audioCtx.resume(); }

    function getFreqFromPitch(p) { const hr=parseInt(document.getElementById('harpKey').value); return BASE_FREQ_C4 * Math.pow(2,(hr+p)/12); }

    function generatePatterns(windowSize) {
        resumeAudio();
        const hr = parseInt(document.getElementById('harpKey').value);
        const scale = scalesDB[document.getElementById('scaleSelect').value];
        const off = (parseInt(document.getElementById('position').value)-1)*7;
        const tr = (hr+off)%12;
        const sNotes = scale.ints.map(i=>(tr+i)%12);
        
        let valid=[];
        richterLogic.forEach(h=>{
            let opts=[h.b,h.d]; if(h.db)opts=opts.concat(h.db); if(h.bb)opts=opts.concat(h.bb); if(h.ob)opts.push(h.ob); if(h.od)opts.push(h.od);
            opts.forEach(o=>{ if(o && sNotes.includes((hr+o.p)%12)) { if(!valid.some(n=>n.p===o.p)) valid.push(o); } });
        });
        valid.sort((a,b)=>a.p-b.p);
        
        let seq=[]; let txt="";
        for(let i=0; i<=valid.length-windowSize; i++) {
            let chunk=[]; for(let j=0; j<windowSize; j++) { chunk.push(valid[i+j].t); seq.push(valid[i+j].t); }
            txt += chunk.join(" ") + "  /  ";
        }
        document.getElementById('patternDisplay').innerText = txt;
        currentPatternSequence = seq;
    }
    function playGeneratedPattern() { resumeAudio(); if(currentPatternSequence.length>0) playLick(currentPatternSequence); }

    function generateProceduralLick() {
        resumeAudio();
        const hr = parseInt(document.getElementById('harpKey').value);
        const scale = scalesDB[document.getElementById('scaleSelect').value];
        const off = (parseInt(document.getElementById('position').value)-1)*7;
        const tr = (hr+off)%12;
        const sNotes = scale.ints.map(i=>(tr+i)%12);
        let valid=[];
        richterLogic.forEach(h=>{
            let opts=[h.b,h.d]; if(h.db)opts=opts.concat(h.db); if(h.bb)opts=opts.concat(h.bb); if(h.ob)opts.push(h.ob); if(h.od)opts.push(h.od);
            opts.forEach(o=>{ if(o && sNotes.includes((hr+o.p)%12)) valid.push(o); });
        });
        valid.sort((a,b)=>a.p-b.p);
        if(valid.length===0) return;

        let starters = valid.filter(v=>(hr+v.p)%12 === tr);
        if(starters.length===0) starters = valid;
        let curr = starters[Math.floor(Math.random()*starters.length)];
        let newLick=[curr.t]; let idx = valid.indexOf(curr);

        for(let i=0; i<7; i++) {
            if(Math.random()<0.2) newLick.push(valid[idx].t);
            else {
                let m = (Math.random()>0.5?1:-1); if(Math.random()<0.3) m*=2;
                let ni = idx+m; if(ni<0) ni=0; if(ni>=valid.length) ni=valid.length-1;
                idx=ni; newLick.push(valid[idx].t);
            }
        }
        currentLickSequence = newLick;
        document.getElementById('lickTabDisplay').innerText = "ðŸ¤– " + newLick.join(" - ");
        playCurrentLick();
    }

    function playCurrentLick() { resumeAudio(); if(currentLickSequence.length>0) playLick(currentLickSequence); }

    function playLick(seq) {
        resumeAudio();
        const ms = parseInt(document.getElementById('lickSpeed').value);
        let t = audioCtx.currentTime;
        seq.forEach((tab,i)=>{
            const cell = document.querySelector(`div[data-tab="${tab}"]`);
            if(cell) { setTimeout(()=>{ cell.classList.add('playing-lick'); setTimeout(()=>cell.classList.remove('playing-lick'), ms-50); }, i*ms); }
            
            let p=-1;
            for(let h of richterLogic) {
                if(h.b.t===tab) {p=h.b.p; break;} if(h.d.t===tab) {p=h.d.p; break;}
                if(h.db){let f=h.db.find(x=>x.t===tab); if(f){p=f.p; break;}}
                if(h.bb){let f=h.bb.find(x=>x.t===tab); if(f){p=f.p; break;}}
                if(h.ob&&h.ob.t===tab){p=h.ob.p; break;} if(h.od&&h.od.t===tab){p=h.od.p; break;}
            }
            
            if(p!==-1) {
                const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
                osc.type='triangle'; osc.frequency.value=getFreqFromPitch(p);
                osc.connect(g); g.connect(audioCtx.destination);
                g.gain.setValueAtTime(0.15, t); g.gain.exponentialRampToValueAtTime(0.001, t+(ms/1000)-0.05);
                osc.start(t); osc.stop(t+(ms/1000));
            }
            t += (ms/1000);
        });
    }

    function playScaleSimple() {
        resumeAudio();
        const hr = parseInt(document.getElementById('harpKey').value);
        const scale = scalesDB[document.getElementById('scaleSelect').value];
        const off = (parseInt(document.getElementById('position').value)-1)*7;
        const tr = (hr+off)%12;
        const sNotes = scale.ints.map(i=>(tr+i)%12);
        let valid=[];
        richterLogic.forEach(h=>{
            let opts=[h.b,h.d]; if(h.db)opts=opts.concat(h.db); if(h.bb)opts=opts.concat(h.bb); if(h.ob)opts.push(h.ob); if(h.od)opts.push(h.od);
            opts.forEach(o=>{ if(o && sNotes.includes((hr+o.p)%12)) { if(!valid.some(n=>n.p===o.p)) valid.push(o); } });
        });
        valid.sort((a,b)=>a.p-b.p);
        
        let t = audioCtx.currentTime;
        valid.forEach((n,i)=>{
            const cell = document.querySelector(`div[data-tab="${n.t}"]`);
            if(cell) { setTimeout(()=>{ cell.classList.add('playing-lick'); setTimeout(()=>cell.classList.remove('playing-lick'), 200); }, i*250); }
            const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
            osc.type='triangle'; osc.frequency.value=getFreqFromPitch(n.p);
            osc.connect(g); g.connect(audioCtx.destination);
            g.gain.setValueAtTime(0.15, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.2);
            osc.start(t); osc.stop(t+0.25);
            t += 0.25;
        });
    }

    function render() {
        const hr = parseInt(document.getElementById('harpKey').value);
        const pos = parseInt(document.getElementById('position').value);
        const off = ((pos-1)*7)%12;
        const tr = (hr+off)%12;
        document.getElementById('resultKey').innerText = notes[tr];
        
        const scale = scalesDB[document.getElementById('scaleSelect').value];
        let style="Blues"; if(scale.cat==='jazz') style="Jazz"; else if(scale.cat==='modi') style=scale.name.split(' ')[0];
        document.getElementById('jamTitle').innerText = `${style} in ${notes[tr]}`;
        const sNotes = scale.ints.map(i=>(tr+i)%12);

        const rows={top:document.getElementById('rowTopAux'),blow:document.getElementById('rowBlow'),num:document.getElementById('rowNum'),draw:document.getElementById('rowDraw'),b1:document.getElementById('rowBottomAux1'),b2:document.getElementById('rowBottomAux2'),b3:document.getElementById('rowBottomAux3')};
        for(let k in rows) rows[k].innerHTML="";
        
        const addCell = (cont,type,txt,abs)=>{
            const d=document.createElement('div'); d.setAttribute('data-tab',txt);
            if(type==='num') { d.className="cell row-num"; d.innerHTML=`<span class="tab-txt">${txt}</span>`; }
            else {
                d.className=`cell ${type}`;
                if(sNotes.includes(abs)) {
                    d.classList.add('active'); if(abs===tr) d.classList.add('root');
                    d.innerHTML=`<span class="tab-txt">${txt}</span><span class="note-txt">${notes[abs]}</span>`;
                } else { d.classList.add('ghost'); d.innerHTML=`<span class="tab-txt">${txt}</span><span class="note-txt">${notes[abs]}</span>`; }
            }
            cont.appendChild(d);
        };
        const addEmpty = (id) => document.getElementById(id).appendChild(document.createElement('div')).className="cell";

        richterLogic.forEach(h=>{
            addCell(rows.num,'num',h.h);
            if(h.h>=7) {
                if(h.ob) addCell(rows.top,'type-over',h.ob.t,(hr+h.ob.p)%12); else if(h.bb) addCell(rows.top,'type-bend',h.bb[0].t,(hr+h.bb[0].p)%12); else addEmpty('rowTopAux');
                if(h.od) addCell(rows.b1,'type-over',h.od.t,(hr+h.od.p)%12); else addEmpty('rowBottomAux1');
                if(h.bb&&h.bb.length>1) addCell(rows.b2,'type-bend',h.bb[1].t,(hr+h.bb[1].p)%12); else addEmpty('rowBottomAux2');
                addEmpty('rowBottomAux3');
            } else {
                if(h.ob) addCell(rows.top,'type-over',h.ob.t,(hr+h.ob.p)%12); else addEmpty('rowTopAux');
                if(h.db&&h.db[0]) addCell(rows.b1,'type-bend',h.db[0].t,(hr+h.db[0].p)%12); else addEmpty('rowBottomAux1');
                if(h.db&&h.db[1]) addCell(rows.b2,'type-bend',h.db[1].t,(hr+h.db[1].p)%12); else addEmpty('rowBottomAux2');
                if(h.db&&h.db[2]) addCell(rows.b3,'type-bend',h.db[2].t,(hr+h.db[2].p)%12); else addEmpty('rowBottomAux3');
            }
            addCell(rows.blow,'row-blow',h.b.t,(hr+h.b.p)%12);
            addCell(rows.draw,'row-draw',h.d.t,(hr+h.d.p)%12);
        });

        // INTERVALS
        const intGrid = document.getElementById('intervalGrid'); intGrid.innerHTML="";
        const harmDiv = document.getElementById('harmDisplay'); harmDiv.innerHTML="";
        
        let allNotes=[];
        richterLogic.forEach(h=>{let opts=[h.b,h.d]; if(h.db)opts=opts.concat(h.db); if(h.bb)opts=opts.concat(h.bb); if(h.ob)opts.push(h.ob); if(h.od)opts.push(h.od); opts.forEach(o=>{if(o)allNotes.push(o)});});
        allNotes.sort((a,b)=>a.p-b.p);

        allNotes.forEach(n=>{
            const abs = (hr+n.p)%12;
            if(sNotes.includes(abs)) {
                let sem = (abs-tr+12)%12;
                intGrid.innerHTML+=`<div class="info-card ${sem===0?'root':''}"><div class="ic-top">${INTERVAL_NAMES[sem]}</div><div class="ic-main">${notes[abs]}</div><div class="ic-sub">${n.t}</div></div>`;
            }
        });

        const harmArr=scale.harm.split(', ');
        scale.ints.forEach((int,i)=>{
            const nIdx = (tr+int)%12;
            const match = allNotes.find(n=>(hr+n.p)%12===nIdx);
            let degLabel=""; if(int===0)degLabel="I"; else if(int===1)degLabel="bII"; else if(int===2)degLabel="II"; else if(int===3)degLabel="bIII"; else if(int===4)degLabel="III"; else if(int===5)degLabel="IV"; else if(int===6)degLabel="bV"; else if(int===7)degLabel="V"; else if(int===8)degLabel="bVI"; else if(int===9)degLabel="VI"; else if(int===10)degLabel="bVII"; else if(int===11)degLabel="VII";
            harmDiv.innerHTML+=`<div class="info-card"><div class="ic-top">${degLabel}</div><div class="ic-main">${notes[nIdx]}</div><div class="ic-sub">${match?match.t:"?"}</div><div class="ic-chord">${harmArr[i]||""}</div></div>`;
        });
        
        saveState();
    }

    function openYouTubeSearch() { window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(document.getElementById('jamTitle').innerText + " Backing Track")}`, '_blank'); }

    let metroTimer=null; let isMet=false;
    function toggleMetronome() {
        resumeAudio();
        const btn=document.getElementById('btn-metro');
        if(isMet){clearInterval(metroTimer); btn.innerText=i18n[curLang].start; isMet=false; document.getElementById('metro-led').className='metro-led';}
        else {
            const bpm=parseInt(document.getElementById('bpm').value);
            let ms=60000/bpm;
            if(document.getElementById('rhythmSel').value==='2')ms/=2; if(document.getElementById('rhythmSel').value==='3')ms/=3; if(document.getElementById('rhythmSel').value==='4')ms/=4;
            isMet=true; btn.innerText=i18n[curLang].stop;
            metroTimer=setInterval(()=>{
                const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
                osc.type='square'; osc.frequency.value=800; osc.connect(g); g.connect(audioCtx.destination);
                g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.05);
                osc.start(); osc.stop(audioCtx.currentTime+0.05);
                const l=document.getElementById('metro-led'); l.classList.add('on'); setTimeout(()=>l.classList.remove('on'),100);
            },ms);
        }
    }

    init();
</script>
</body>
</html>